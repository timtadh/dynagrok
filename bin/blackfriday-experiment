#!/usr/bin/env bash

if ! go install github.com/timtadh/dynagrok; then
    echo "failed to compile dynagrok"
    exit 1
fi

dgpath=$1
if [[ -z "$dgpath" ]]; then
    echo "must supply the path to dynagrok's source tree as the first arg"
    exit 1
fi

goroot=$2
if [[ -z "$goroot" ]]; then
    echo "must supply a GOROOT (which is a git checkout) as the second arg"
    exit 1
fi

TOTAL=$3
if [[ -z "$TOTAL" ]]; then
    echo "must supply the number of mutations as arg 3"
    exit 1
fi

COUNT=$4
if [[ -z "$COUNT" ]]; then
    echo "must supply the number mutants to make as arg 4"
    exit 1
fi

TARGET=$5
if [[ -z "$TARGET" ]]; then
    echo "must supply the target dir as arg 5"
    exit 1
fi

DYNAGROK=$(which dynagrok)

function run {
  >&2 echo $ "${@}"
  "${@}"
}

BUILD=$TARGET/build

run mkdir -p $TARGET
run rm -r  $BUILD/goroot/src/dgruntime $BUILD/gopath

for ((i=1;i<=$COUNT;i++)); do
    mutdir=$TARGET/m$i
    mut=$mutdir/blackfriday
    tests=$mutdir/tests
    oks=$mutdir/oks
    fails=$mutdir/fails
    run rm -r $mutdir
    run mkdir -p $mutdir
    run rm -r $BUILD/mutations $BUILD/gopath
    if ! run \
        $DYNAGROK -r $goroot -d $dgpath -g $dgpath/examples \
            mutate --keep-work -w $BUILD --instrument -t $TOTAL \
                   --mutation=branch -o $mut dynagrok/examples/blackfriday
    then
        echo "creating the $i blackfriday mutant failed"
        exit 1
    fi
    run cp $BUILD/mutations $mutdir/mutations
    run mkdir -p $oks/tests
    run mkdir -p $fails/tests $fails/failures
    t=1
    IFS=$'\n'
    for path in $(cat $dgpath/mdfiles | awk 'BEGIN {srand()} !/^$/ { if (rand() <= .25) print $0}' | head -n 25); do
        echo "running test $t $path"
        export DGPROF=$tests/$t
        run mkdir -p $DGPROF
        cat $path | run timeout 30s $mut -test=true > /dev/null
        if [[ $? -eq 124 ]]; then
            echo "skipping test it timed out"
        elif [[ -f $DGPROF/failures ]]; then
            run cp $path $fails/tests/$t-$(basename $path | tr ' ' '-')
            run cp $DGPROF/failures $fails/failures/$t
        else
            run cp $path $oks/tests/$t-$(basename $path | tr ' ' '-')
        fi
        t=$((t+1))
    done
    sleep .02
    if ! [ "$(ls -A $oks/tests)" ] || ! [ "$(ls -A $fails/tests)" ]; then
        echo "mutant either always failed or always worked"
        echo "removing it"
        run rm -rf $mutdir
        i=$((i-1))
        echo "retrying"
        continue
    else
        ## saving the source code
        run rm -rf $BUILD/goroot/pkg
        run rm -rf $BUILD/goroot/bin
        run rm -rf $BUILD/gopath/pkg
        run rm -rf $BUILD/gopath/bin
        (
          run cd $TARGET
          run tar czf build.tar.gz build
        )
        run cp $TARGET/build.tar.gz $mutdir
    fi
done
